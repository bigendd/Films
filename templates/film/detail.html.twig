{# templates/film/detail.html.twig #}

{% extends 'base.html.twig' %}

{% block body %}
<div class="container">
    <h1>{{ film.title }}</h1>

    <div class="film-details">
        <div class="film-poster">
            <img src="https://image.tmdb.org/t/p/w300{{ film.poster_path }}" alt="{{ film.title }} poster">
        </div>
        <div class="film-info">
            <p>{{ film.overview }}</p>
            <p>Date de sortie: {{ film.release_date }}</p>
            <p>Note: {{ film.vote_average }}</p>

            {% if film.videos is not empty %}
                <h2>Bande-annonce</h2>
                {% set trailerFound = false %}
                {% for video in film.videos %}
                    {% if video.type == 'Trailer' and not trailerFound %}
                        <div class="video-container">
                            <iframe width="560" height="315" src="https://www.youtube.com/embed/{{ video.key }}" frameborder="0" allowfullscreen></iframe>
                        </div>
                        {% set trailerFound = true %}
                    {% endif %}
                {% endfor %}
                {% if not trailerFound %}
                    <p>Aucune bande-annonce disponible.</p>
                {% endif %}
            {% else %}
                <p>Aucune vid√©o disponible.</p>
            {% endif %}

            {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                {% if isFavorite %}
                    <p>Ce film est dans vos favoris.</p>
                {% else %}
                    <form action="{{ path('film_add_favorite', {'id': film.id}) }}" method="post">
                        <button type="submit" class="btn btn-secondary">Ajouter aux favoris</button>
                    </form>
                {% endif %}
                {% if not is_granted('ROLE_ADMIN') %}
                    <a href="{{ path('avis_new', {'filmId': film.id}) }}" class="btn btn-secondary">Ajouter un avis</a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <h2>Commentaire</h2>
    {% for avi in avis %}
        <div class="avis">
            <p><strong>{{ avi.utilisateur.email }}:</strong></p>
            <p>{{ avi.commentaire }}</p>
            <p><small>Reviewed on {{ avi.dateDeCreation|date('Y-m-d H:i') }}</small></p>
            {% if is_granted('IS_AUTHENTICATED_FULLY') and avi.utilisateur == app.user %}
                <a href="{{ path('avis_edit', {'id': avi.id}) }}" class="btn btn-secondary">Edit</a>
                <form action="{{ path('avis_delete', {'id': avi.id}) }}" method="post" style="display:inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ avi.id) }}">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            {% elseif is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN') %}
                <form action="{{ path('avis_archive', {'id': avi.id}) }}" method="post" style="display:inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('archive' ~ avi.id) }}">
                    <button type="submit" class="btn btn-secondary">Archiver</button>
                </form>
            {% elseif is_granted('IS_AUTHENTICATED_FULLY') %}
                <a href="{{ path('signalement_new', {'id': avi.id}) }}" class="btn btn-danger">Signaler</a>
            {% endif %}
        </div>
        
    {% else %}
        <p>Aucun avis pour l'instant.</p>
    {% endfor %}
</div>
{% endblock %}
